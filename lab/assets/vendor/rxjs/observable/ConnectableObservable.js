"use strict";var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var c in e)e.hasOwnProperty(c)&&(t[c]=e[c]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},Subject_1=require("../Subject"),Observable_1=require("../Observable"),Subscriber_1=require("../Subscriber"),Subscription_1=require("../Subscription"),ConnectableObservable=function(t){function e(e,n){t.call(this),this.source=e,this.subjectFactory=n,this._refCount=0}return __extends(e,t),e.prototype._subscribe=function(t){return this.getSubject().subscribe(t)},e.prototype.getSubject=function(){var t=this._subject;return t&&!t.isStopped||(this._subject=this.subjectFactory()),this._subject},e.prototype.connect=function(){var t=this._connection;return t||(t=this._connection=new Subscription_1.Subscription,t.add(this.source.subscribe(new ConnectableSubscriber(this.getSubject(),this))),t.closed?(this._connection=null,t=Subscription_1.Subscription.EMPTY):this._connection=t),t},e.prototype.refCount=function(){return this.lift(new RefCountOperator(this))},e}(Observable_1.Observable);exports.ConnectableObservable=ConnectableObservable;var ConnectableSubscriber=function(t){function e(e,n){t.call(this,e),this.connectable=n}return __extends(e,t),e.prototype._error=function(e){this._unsubscribe(),t.prototype._error.call(this,e)},e.prototype._complete=function(){this._unsubscribe(),t.prototype._complete.call(this)},e.prototype._unsubscribe=function(){var t=this.connectable;if(t){this.connectable=null;var e=t._connection;t._refCount=0,t._subject=null,t._connection=null,e&&e.unsubscribe()}},e}(Subject_1.SubjectSubscriber),RefCountOperator=function(){function t(t){this.connectable=t}return t.prototype.call=function(t,e){var n=this.connectable;n._refCount++;var c=new RefCountSubscriber(t,n),r=e._subscribe(c);return c.closed||(c.connection=n.connect()),r},t}(),RefCountSubscriber=function(t){function e(e,n){t.call(this,e),this.connectable=n}return __extends(e,t),e.prototype._unsubscribe=function(){var t=this.connectable;if(!t)return void(this.connection=null);this.connectable=null;var e=t._refCount;if(e<=0)return void(this.connection=null);if(t._refCount=e-1,e>1)return void(this.connection=null);var n=this.connection,c=t._connection;this.connection=null,!c||n&&c!==n||c.unsubscribe()},e}(Subscriber_1.Subscriber);